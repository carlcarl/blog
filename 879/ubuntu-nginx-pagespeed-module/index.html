<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Ubuntu nginx pagespeed module
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <meta property="og:site_name" content="carlcarl's blog" />
                <meta property="og:type" content="article" />
                <meta property="og:title" content="Ubuntu nginx pagespeed module" />
                <meta property="og:url" content="http://blog.carlcarl.me/879/ubuntu-nginx-pagespeed-module/" />
                <meta property="og:description" content="Ubuntu 版本：12.04 Nginx 版本：1.4.1 pagespeed 版本：1.5.27.3 記錄一下安裝的步驟： # 到 home 目錄下做，看個人習慣就是 cd ~ # add-apt-repository 這個指令需要裝 python-software-properties sudo apt-get install python-software-properties sudo add-apt-repository ppa:nginx/stable sudo apt-get update # 下載 nginx source code sudo apt-get source nginx # 裝 build nginx 需要的套件 sudo apt-get ..." />
                    <meta property="article:tag" content="nginx" />
                    <meta property="article:tag" content="pagespeed" />
                    <meta property="article:tag" content="ubuntu" />
            <link rel="stylesheet" href="http://blog.carlcarl.me/theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://blog.carlcarl.me/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="http://blog.carlcarl.me/theme/css/main.css">

    <link rel="stylesheet" href="http://blog.carlcarl.me/theme/css/blog.css">
    <link rel="stylesheet" href="http://blog.carlcarl.me/theme/css/github.css">
        <link href="http://blog.carlcarl.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="carlcarl's blog Atom Feed" />
        <script src="http://blog.carlcarl.me/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="http://blog.carlcarl.me"><h1><i class="icon-coffee"></i> carlcarl's blog</h1></a>
        <p id="site-desc"></p>
    </hgroup>
    <nav>
        <ul id="nav-links">
        </ul>
    </nav>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> and <a href="http://python.org/" target="python">Python</a>. Theme by <a href="https://github.com/hdra/pelican-cait" target="github">hndr</a>.
    </p>
    <p>
        Textures by <a href="http://subtlepatterns.com/" target="subtlepatterns">Subtle Pattern</a>. Font Awesome by <a href="http://fortawesome.github.io/Font-Awesome/" target="github">Dave Grandy</a>.
    </p>
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2013-06-03T21:25:00" pubdate>
                            Mon 03 June 2013
                        </time>
                        <a href="http://blog.carlcarl.me/879/ubuntu-nginx-pagespeed-module/" rel="bookmark"><h1>Ubuntu nginx pagespeed module</h1></a>
                    </header>

                    <section class="post-content">
                        <p>Ubuntu 版本：12.04 Nginx 版本：1.4.1 pagespeed 版本：1.5.27.3
記錄一下安裝的步驟：</p>
<div class="highlight"><pre><span class="c"># 到 home 目錄下做，看個人習慣就是</span>
<span class="nb">cd</span> ~
<span class="c"># add-apt-repository 這個指令需要裝 python-software-properties</span>
sudo apt-get install python-software-properties
sudo add-apt-repository ppa:nginx/stable
sudo apt-get update
<span class="c"># 下載 nginx source code</span>
sudo apt-get <span class="nb">source </span>nginx
<span class="c"># 裝 build nginx 需要的套件</span>
sudo apt-get build-dep nginx
<span class="c"># 裝 pagespeed 需要的套件</span>
sudo apt-get install build-essential zlib1g-dev libpcre3 libpcre3-dev

<span class="c"># 下載 pagespeed</span>
wget https://github.com/pagespeed/ngx_pagespeed/archive/release-1.5.27.3-beta.zip
unzip release-1.5.27.3-beta.zip
<span class="nb">cd </span>ngx_pagespeed-release-1.5.27.3-beta/
wget https://dl.google.com/dl/page-speed/psol/1.5.27.3.tar.gz
tar -xzvf 1.5.27.3.tar.gz
 
<span class="nb">cd</span> ~/nginx-1.4.1/
<span class="c"># 我會需要用到 https，所以加上 --with-http_ssl_module</span>
./configure --add-module<span class="o">=</span><span class="nv">$HOME</span>/ngx_pagespeed-release-1.5.27.3-beta --with-http_ssl_module
make
sudo make install
 
<span class="c"># 建個 link。也可以 link 到別的位置，不過記得下面 init sctipt 中的 DAEMON 的位置要跟著改</span>
sudo ln -s /usr/local/nginx/sbin/nginx /usr/local/sbin/nginx
</pre></div>


<p>如果在之前有裝過 nginx 的話，在 <code>/etc/init.d/</code> 底下應該有個 nginx 的
init script，我是直接用這個，不過還要加點修改：</p>
<div class="highlight"><pre><span class="cp"># DAEMON 改成這樣</span>
<span class="n">DAEMON</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span>
</pre></div>


<p>接著修改 <code>/usr/local/nginx/conf/nginx.conf</code>：（這邊是因為我在 configure
的時候沒有另外指定位置，所以在這裡）</p>
<div class="highlight"><pre># pid 改成這樣，以對應到 init script 中的設定，不然不能 restart 和 stop
pid /var/run/nginx.pid;
...
http {
    # 加上這兩行以啟用 pagespeed
    pagespeed on;
    pagespeed FileCachePath /var/ngx_pagespeed_cache;
...
}
</pre></div>


<p>接著編輯每個 virtualhost 的 conf：</p>
<div class="highlight"><pre>server {
...
    # 加上以下幾行
    location ~ &quot;\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+&quot; { add_header &quot;&quot; &quot;&quot;; }
    location ~ &quot;^/ngx_pagespeed_static/&quot; { }
    location ~ &quot;^/ngx_pagespeed_beacon$&quot; { }
    location /ngx_pagespeed_statistics { allow 127.0.0.1; deny all; }
    location /ngx_pagespeed_message { allow 127.0.0.1; deny all; }
...
}
...
</pre></div>


<p>新增 <code>/var/ngx_pagespeed_cache</code> 這個資料夾，並讓 nginx
有寫入的權限。這個資料夾是讓 pagespeed 放 cache 用的，視情況可以考慮放在
<code>/dev/shm/</code> 底下加快速度，不過我自己是還沒試過就是 :P。這邊我的 nginx
是用 <code>www-data</code>，如以下操作：</p>
<div class="highlight"><pre>sudo mkdir /var/ngx_pagespeed_cache
sudo chown www-data:www-data /var/ngx_pagespeed_cache
</pre></div>


<p>啟動 nginx:</p>
<div class="highlight"><pre>sudo service nginx start
</pre></div>


<p>接著放個網頁並試試看以下指令，有的話就代表成功了</p>
<div class="highlight"><pre>curl -I -p 你的網址 | grep X-Page-Speed
</pre></div>


<p>以上是基本的安裝，pagespeed
還有提供很多設定，要指定才會有效，之後有空再另外寫一篇補完。</p>
<p>參考網址：<br />
<a href="https://github.com/pagespeed/ngx_pagespeed">https://github.com/pagespeed/ngx_pagespeed</a><br />
<a href="http://serverfault.com/questions/502764/how-to-build-nginx-1-4-0-and-ngx-pagespeed-in-ubuntu-debian">http://serverfault.com/questions/502764/how-to-build-nginx-1-4-0-and-ngx-pagespeed-in-ubuntu-debian</a>
<a href="http://serverfault.com/questions/180808/how-to-get-latest-nginx-using-apt-ubuntu">http://serverfault.com/questions/180808/how-to-get-latest-nginx-using-apt-ubuntu</a>
<a href="https://www.digitalocean.com/community/articles/how-to-install-the-latest-version-of-nginx-on-ubuntu-12-10">https://www.digitalocean.com/community/articles/how-to-install-the-latest-version-of-nginx-on-ubuntu-12-10</a>
<a href="http://blog.linuxeye.com/318.html">http://blog.linuxeye.com/318.html</a></p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="http://blog.carlcarl.me/category/linux.html">linux</a></p>
                        <p>Tags: <a href="http://blog.carlcarl.me/tag/nginx.html">nginx</a>, <a href="http://blog.carlcarl.me/tag/pagespeed.html">pagespeed</a>, <a href="http://blog.carlcarl.me/tag/ubuntu.html">ubuntu</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'carlcarl';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

<script>
    var _gaq=[['_setAccount','UA-24249240-5'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
        <script src="http://blog.carlcarl.me/theme/js/main.js"></script>
    </body>
</html>