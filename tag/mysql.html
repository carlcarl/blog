<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>carlcarl's blog - mysql</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">carlcarl's blog </a></h1>
                <nav><ul>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/495/mysql-table_cache-fail/">MySQL table_cache fail</a></h1>
<footer class="post-info">
        <abbr class="published" title="2012-05-31T15:26:00">
                四 31 5月 2012
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="/author/carlcarl.html">carlcarl</a>
        </address>
<p>In <a href="/category/database-mysql.html">database, mysql</a>. </p>
<p>tags: <a href="/tag/mysql.html">mysql</a><a href="/tag/table_cache.html">table_cache</a></p>
</footer><!-- /.post-info --><p>一直記得之前好像遇過同樣的問題，後來才想到應該是 ulimit 的限制。ulimit
會限制一個 user 可開啟的檔案，MySQL 也不例外，預設會被限制在最多開 1024
個檔案，以下是跟 MySQL 有關的算式：</p>
<div class="highlight"><pre>max_open_files = max_connections + (table_cache * 2)
</pre></div>


<p><code>max_open_files</code> 基本上是固定 1024，所以後面的部份一旦自己設太大，MySQL
會自己再調整參數，所以可能會遇到你將 <code>max_connections</code> 設到
1024、<code>table_cache</code> 設到512，可是在 MySQL command line
中去查，<code>table_cache</code> 卻還是預設 64 的情形，<code>max_connections</code>
的值也會同樣被降低。</p>
<p>要預防這種情形就必須修改 <code>ulimit</code> 限制，在 <code>/etc/security/limits.conf</code> 加上</p>
<div class="highlight"><pre><span class="n">mysql</span> <span class="n">soft</span> <span class="n">nofile</span> <span class="mi">4096</span>
<span class="n">mysql</span> <span class="n">hard</span> <span class="n">nofile</span> <span class="mi">8192</span>
</pre></div>


<p>接著重開 MySQL 即可。</p>
<p>參考網址：<br />
<a href="http://www.neweguo.com/club/display.asp?id=44">http://www.neweguo.com/club/display.asp?id=44</a></p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/486/mysql-insert-if-duplicate-then-update/" rel="bookmark"
                           title="Permalink to MySQL insert if duplicate then update">MySQL insert if duplicate then update</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-05-29T22:42:00">
                二 29 5月 2012
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="/author/carlcarl.html">carlcarl</a>
        </address>
<p>In <a href="/category/database.html">database</a>. </p>
<p>tags: <a href="/tag/mysql.html">mysql</a></p>
</footer><!-- /.post-info -->                <p>在做壓力測試的時候發現出來的數值不太對，後來看了一下，發現是因為程式裏面是拿
SELECT 出來的資料加 1 並給 UPDATE 來使用，但是這樣並不是一個 atomic 的
operation，如果在 SELECT 完之後有其他人也進行 SELECT
就變成會拿一樣的資料且都加 1，兩個做完 UPDATE 的結果就會只是加 1
過的數據，但是預期的結果應該要是加 2 的。<br />
<!--more--><br />
查了一下資料，發現有個簡單的語法可以使用：</p>
<div class="highlight"><pre><span class="cm">/* If id is the UNIQUE KEY */</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">table</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="k">ON</span> <span class="n">DUPLICATE</span> <span class="k">KEY</span> <span class="k">UPDATE</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1 ...</span></pre></div>
                <a class="readmore" href="/486/mysql-insert-if-duplicate-then-update/">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/226/mysql-db-engine-with-log-archive/" rel="bookmark"
                           title="Permalink to MySQL DB engine with log: Archive">MySQL DB engine with log: Archive</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2011-12-17T18:00:00">
                六 17 12月 2011
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="/author/carlcarl.html">carlcarl</a>
        </address>
<p>In <a href="/category/mysql.html">mysql</a>. </p>
<p>tags: <a href="/tag/archive.html">archive</a><a href="/tag/innodb.html">innodb</a><a href="/tag/mariadb.html">mariadb</a><a href="/tag/myisam.html">myisam</a><a href="/tag/mysql.html">mysql</a></p>
</footer><!-- /.post-info -->                <p>前一陣子在看什麼 engine 比較適合拿來單純存
log，後來看到 <code>Archive</code> 這個似乎不錯，主要有以下優點：</p>
<ul>
<li>insert 速度更快。</li>
<li>佔的資料量較 Myisam 少。</li>
</ul>
<p>但是有優勢，就會有相對的劣勢，Archive 有以下缺點：</p>
<ul>
<li>不支援 delete 和 update，只能 insert 和 select。</li>
<li>不支援 index。</li>
</ul>
<p>（如果你是想要存每次最後登入時間的話，那 Archive 的確是不適合，因為不支援
index 和 update。）</p>
<p>但是以現實角度來看單純的 log 表，像是存每次登入的紀錄：</p>
<ul>
<li>其實真的就只會用到 insert，會用到 delete 和 update 那這個應該不太叫
    log。</li>
<li>作 select 的機率也是微乎其微 ...</li></ul>
                <a class="readmore" href="/226/mysql-db-engine-with-log-archive/">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/170/mysql-change-engine-of-all-tables/" rel="bookmark"
                           title="Permalink to MySQL change engine of all tables">MySQL change engine of all tables</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2011-12-10T00:22:00">
                六 10 12月 2011
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="/author/carlcarl.html">carlcarl</a>
        </address>
<p>In <a href="/category/mysql.html">mysql</a>. </p>
<p>tags: <a href="/tag/aria.html">aria</a><a href="/tag/mariadb.html">mariadb</a><a href="/tag/mysql.html">mysql</a></p>
</footer><!-- /.post-info -->                <p>最近裝好<a href="http://mariadb.org/">mariaDB</a>，想順便把之前用的 <code>Myisam</code> 改成新的 <code>Aria</code> engine，可是
table 一堆，在 phpmyadmin 介面上也找不到比較方便的功能可以直接轉換所有的
table engine。</p>
<p>後來查了一下，有幾種作法，一種是寫 php，然後 for 迴圈用 sql 修改
engine，不過為了這個寫 php 總是覺得很奇怪。後來查到另外一個作法：</p>
<div class="highlight"><pre><span class="k">select</span> <span class="n">concat</span><span class="p">(</span><span class="s1">&#39;alter table &#39;</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span> <span class="s1">&#39; engine = Aria;&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span>
<span class="k">where</span> <span class="n">table_schema</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;db1&#39;</span><span class="p">,</span><span class="s1">&#39;db2&#39;</span><span class="p">,....,</span><span class="s1">&#39;dbN&#39;</span><span class="p">)</span>
</pre></div>


<p>要注意 <code>table_name</code> 不用改，這個是 <code>informatio_schema ...</code></p>
                <a class="readmore" href="/170/mysql-change-engine-of-all-tables/">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 1
</p>
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>