<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>carlcarl's blog - conntrack</title>
        <link rel="stylesheet" href="http://blog.carlcarl.me/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blog.carlcarl.me/">carlcarl's blog </a></h1>
                <nav><ul>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.carlcarl.me/1080/linux-conntrack-delete-destination-nat/">Linux conntrack delete destination NAT</a></h1>
<footer class="post-info">
        <abbr class="published" title="2013-06-27T16:41:00">
                四 27 6月 2013
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.carlcarl.me/author/carlcarl.html">carlcarl</a>
        </address>
<p>In <a href="http://blog.carlcarl.me/category/linux.html">linux</a>. </p>
<p>tags: <a href="http://blog.carlcarl.me/tag/conntrack.html">conntrack</a></p>
</footer><!-- /.post-info --><p>最近遇到在測 throughput 中，有一定機率無法關掉 DMZ
的問題，而且這邊只要關掉 throughput 後，DMZ 就會順利關掉，看起來像是
throughput 的連線讓被刪掉的 conntrack 連線又復活(?)了這樣 =.=。</p>
<!--more-->

<p>看了一下 firewall 的 rule，裡面確實是有刪除 conntrack connection 的
rule，指令如下：</p>
<div class="highlight"><pre>conntrack -D conntrack -g -r xxx.xxx.xxx.xxx
</pre></div>


<p>看了一下 <code>conntrack －L conntrack</code> 的記錄，grep 了在接收 throughput 的
port，發現還是有連線存在，來源是從 NAT
內部到外面...，所以看來這個連線也會讓外部的封包有機會進來的樣子。</p>
<p>第一直覺就是把這邊的連線也砍掉啦，規則就從
<code>conntrack -L conntrack -g -r</code> 這裡拿到所有的 dest ip，然後一個一個用
<code>conntrack -D conntrack -d dest_ip</code> 砍掉。</p>
<p>不過事情好像沒那麼美好 orz，後來用 <code>conntrack</code> 看，發現 source ip
的部分應該也要濾掉，而且因為 throughput
太大，有機會讓被砍掉的連線復活，所以又加了個迴圈來砍，聽起來有點暴力啊(汗)。這邊因為有些特殊需求，所以整個
shell 程式必須用 c 產生，判斷有沒有殺掉的部分就用
<code>popen("conntrack -L conntrack | grep xxx.xxx.xxx.xxx", "r")</code> 做，轉成
shell 的話大概如下，這邊迴圈就不寫了:P：</p>
<div class="highlight"><pre><span class="c"># 因為有可能拿到複數個，所以需要用雙引號包起來</span>
<span class="nv">outside_ip</span><span class="o">=</span><span class="s2">&quot;$(conntrack -L conntrack -g -r xxx.xxx.xxx.xxx | awk &#39;{ print $5 }&#39; | cut -f2 -d=)&quot;</span>
conntrack -D conntrack -g -r xxx.xxx.xxx.xxx

<span class="nv">check</span><span class="o">=</span><span class="s2">&quot;$(conntrack -L conntrack | grep xxx.xxx.xxx.xxx)&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$check&quot;</span> <span class="o">]</span>; <span class="k">then</span>
    <span class="c"># -r 表示如果前面給的參數是空的話，就不執行後面的指令</span>
    <span class="nb">echo</span> <span class="nv">$outside_ip</span> | xargs -r conntrack -D conntrack -d
    <span class="nb">echo</span> <span class="nv">$outside_ip</span> | xargs -r conntrack -D conntrack -s
<span class="k">fi</span>
</pre></div>


<p>整個解法其實沒有說很好，不知道還有沒有什麼更漂亮的解法就是了。</p>
<h2>2013/10/03 補充</h2>
<p>同事後來用了一個更好的方法修掉了，內容如下：</p>
<div class="highlight"><pre>iptables -t raw -I PREROUTING -s source_ip -j DROP
conntrack -D conntrack -g -r source_ip
iptables -t raw -D PREROUTING -s source_ip -j DROP
</pre></div>


<p>因為 raw 這張 table + PREROUTING 是在 ip conntrack
之前，所以先增加一個規則在前面將 source ip drop 掉，然後後面再清掉
conntrack 中的內容，清完後再把這條規則清掉就可以了。</p>
<p>參考網址：<br />
<a href="http://manpages.ubuntu.com/manpages/jaunty/man8/conntrack.8.html">conntrack manual</a><br />
<a href="http://hi.baidu.com/weioip/item/3a48aaf45efa600cd89e7296">iptables中的conntrack記錄</a><br />
<a href="http://hi.baidu.com/farmerluo/item/f49bbdc0e390a52dee4665bb">用iptables的raw表解決ip_conntrack: table full, dropping packet的問題</a>  </p><p>There are <a href="http://blog.carlcarl.me/1080/linux-conntrack-delete-destination-nat/#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'carlcarl';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>